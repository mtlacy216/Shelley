<!DOCTYPE html>
<html>
<head>
    <title>Camera Access</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            overflow: hidden;
        }
        #videoContainer {
            width: 25%;
            height: 25%;
            position: relative;
            margin: auto;
        }
        #camera {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        #flash {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: white;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease-out;
        }
        #response {
            margin-top: 20px;
            padding: 10px;
            border: 1px solid #ccc;
            min-height: 100px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="videoContainer">
        <video id="camera" autoplay></video>
        <div id="flash"></div>
    </div>
    <button id="capture">Capture</button>
    <button id="fullscreen">Toggle Fullscreen</button>
    <canvas id="canvas" style="display:none;"></canvas>
    <img id="photo" style="display:none;">
    
    <div id="response"></div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
    <script>
        let videoContainer = document.getElementById('videoContainer');
        let video = document.getElementById('camera');
        let flash = document.getElementById('flash');
        let canvas = document.getElementById('canvas');
        let photo = document.getElementById('photo');
        let captureButton = document.getElementById('capture');
        let fullscreenButton = document.getElementById('fullscreen');

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
            navigator.mediaDevices.getUserMedia({ video: true })
                .then(function(stream) {
                    video.srcObject = stream;
                    video.play();
                })
                .catch(function(err) {
                    console.log("An error occurred: " + err);
                });
        }

        captureButton.addEventListener('click', function() {
            triggerFlash();
            capturePhoto();
        });

        function triggerFlash() {
            flash.style.opacity = 1;
            setTimeout(function() {
                flash.style.opacity = 0;
            }, 150);
        }

        function capturePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
            let imageData = canvas.toDataURL('image/png'); // Get the full Base64 data
            photo.setAttribute('src', imageData); // Optional: For verification, can be removed
            // Send the Base64 image data directly
            sendImageToFlask(imageData);
        }

        function sendImageToFlask(base64Data) {
            fetch('http://localhost:5000/receive-image-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({imageData: base64Data})
            })
            .then(response => response.json())
            .then(data => {
                console.log('Response from Flask:', data);
                // Optionally update the HTML page based on the response
            })
            .catch(error => {
                console.error('Error sending image data to Flask:', error);
            });
        }

        fullscreenButton.addEventListener('click', function() {
            if (!document.fullscreenElement) {
                videoContainer.requestFullscreen().catch(err => {
                    alert(`Error attempting to enable full-screen mode: ${err.message} (${err.name})`);
                });
            } else {
                document.exitFullscreen();
            }
        });

        // Connect to the WebSocket
        const socket = io('http://localhost:5000');  // Update the URL if needed

        socket.on('connect', function() {
            console.log('WebSocket connected');
        });

        socket.on('disconnect', function() {
            console.log('WebSocket disconnected');
        });

        socket.on('stream_response', function(data) {
            console.log('Received stream_response event:', data);
            let responseElement = document.getElementById('response');
            responseElement.innerHTML += data.content;
        });

        socket.on('error', function(error) {
            console.error('WebSocket error:', error);
        });
    </script>
</body>
</html>